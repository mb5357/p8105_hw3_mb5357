---
title: "p8105_hw3_mb5357"
author: "Maria Beg"
date: "2025-10-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(p8105.datasets)
data("instacart")
```

## QUESTION 1

**Description of the Instacart Dataset**

The `instacart` dataset is a line-item level table of grocery orders from Instacart, where each row represents a single product in a single order.

The dataset contains 13,844,617 observations and 15 variables. 

Key variables include `order_id`, `product_id`, `user_id`, `add_to_cart_order` (position of the item in the cart), `reordered` (0/1), `order_dow` (day of week), and `order_hour_of_day`. Orders are categorized by `eval_set`, and user purchase history is captured via `order_number`. 

The dataset can be joined with metadata tables such as `products`, `aisles`, and `departments` using `product_id`. In this version of the dataset, all observations come from the "train" evaluation set. 

For example, user 112108 placed their 4th order on day 4 of the week at 10 AM. This order (order ID 1) contained eight products, including "Bulgarian Yogurt", "Organic Celery Hearts", and "Organic Hass Avocado". Each product appears in a separate row, with variables indicating the order in which the item was added to the cart (e.g., "Bulgarian Yogurt" was first), whether it was reordered (1 = yes, 0 = no), and what aisle and department it belongs to (e.g., "fresh fruits" in the "produce" department).


**Number of aisles and most ordered aisles**

```{r}

instacart |> 
  count(
    aisle, sort = TRUE) |>
  mutate(
    total_aisles = n()) |>
  relocate(
    total_aisles, .before = aisle)

```

*There are 134 aisles in total. Fresh vegetables and fresh fruits aisles are the most items ordered from.*


**Plot of items ordered per aisle**

```{r,  fig.width=10, fig.height=8}

instacart |>
  count(
    aisle, sort = TRUE) |>
  filter(
    n > 10000) |>
  mutate(
    aisle = reorder(aisle, n)) |>
  ggplot(aes(x = n, y = aisle)) +
  geom_col(fill = "steelblue") +
  labs(
    title = "Number of Items Ordered by Aisle",
    x = "Number of Items Ordered",
    y = "Aisle"
  ) +
  theme_minimal()

```


**Top 3 items in selected aisles**

```{r}

top_items_table <- instacart |>
  filter(aisle == "baking ingredients" | 
         aisle == "dog food care" | 
         aisle == "packaged vegetables fruits") |>
  count(
    aisle, 
    product_name, 
    name = "orders") |> 
  group_by(aisle) |> 
  slice_max(orders, n = 3) |> 
  ungroup()

top_items_table |> 
  knitr::kable()

```


**Mean order hour for "Pink Lady Apples" and "Coffee Ice Cream" by day of week**

```{r}

day_names <- c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat")

mean_hour_table <- instacart |>
  filter(product_name == "Pink Lady Apples" | 
         product_name == "Coffee Ice Cream") |>
    mutate(day_name = factor(day_names[order_dow + 1], 
                             levels = day_names)) |>
    group_by(product_name, 
           day_name) |>
    summarize(mean_order_hour = round(mean(order_hour_of_day), 1), 
              .groups = "drop") |>
    pivot_wider(
    names_from = day_name,
    values_from = mean_order_hour
    )

mean_hour_table |> 
  knitr::kable()

```


## Question 2

**Import and Clean the datasets**

```{r}

zipcodes_df <- read_csv("Zip Codes.csv", show_col_types = FALSE) |>
  janitor::clean_names() |>
  mutate(
     county = case_when(
      county == "New York" ~ "Manhattan",
      county == "Kings"    ~ "Brooklyn",
      county == "Richmond" ~ "Staten Island",
      TRUE ~ county
    )
  ) |>
  distinct(zip_code, .keep_all = TRUE) |>
  select(county, zip_code)


zori_df <- read_csv("Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv", 
                    show_col_types = FALSE) |>
  janitor::clean_names()|>
  pivot_longer(
    cols = starts_with("x20"), 
    names_to = "date", 
    values_to = "zori"
  ) |>
  mutate(
    date = lubridate::ymd(str_remove(date, "x")),
    year = year(date),
    month = month(date)
  ) |>
  select(region_name, year, month, zori)



combined_df <- left_join(zori_df, zipcodes_df, 
                         by = c("region_name" = "zip_code"))
  
combined_df <- combined_df |>
    filter(!is.na(zori)) |>
    rename(zip_code = region_name,
         borough = county)

```


**ZIP Codes Observation**

```{r}

zip_counts <- combined_df |>
  group_by(zip_code) |>
  summarize(n_months = n()) |>
  ungroup()

zip_counts |>
  summarize(
    full_coverage = sum(n_months == 116),
    very_sparse = sum(n_months < 10)
  )

```

A total of 48 ZIP codes have complete data, appearing in all 116 months from January 2015 to August 2024. Conversely, 26 ZIP codes are observed fewer than 10 times during this period. ZIP codes with full coverage likely represent stable residential areas with consistent rental activity and reliable data reporting. Those with sparse observations may reflect areas with limited rental market activity, newer ZIP codes, or data gaps.


**Average rental price per borough and year**

```{r}

borough_year_table <- combined_df |>
  group_by(borough,
           year) |>
  summarize(avg_rent = mean(zori, na.rm = TRUE), 
            .groups = "drop") |>
  arrange(borough, year) |>
  pivot_wider(
    names_from = borough,
    values_from = avg_rent
  )

borough_year_table |> 
  knitr::kable()

```

From 2015 to 2024, average rental prices steadily increased across all boroughs with available data. Manhattan consistently exhibits the highest rents, followed by Brooklyn and Queens. The Bronx has the lowest average rents but demonstrates notable growth over the period. Data for Staten Island begins in 2020, showing a similar upward trend. Overall, the table reflects a citywide rise in rental prices, with Manhattan and Brooklyn leading both in cost and growth.


**NYC rental prices within ZIP codes**

```{r}

library(ggplot2)




```

